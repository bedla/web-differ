<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>WebDiffer</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="/webjars/bootstrap/4.3.1/css/bootstrap.css">
    <script src="/webjars/jquery/3.3.1/jquery.js"></script>
    <script src="/webjars/bootstrap/4.3.1/js/bootstrap.js"></script>
</head>
<body>
<div class="container">
    <div th:replace="layout :: header"></div>
    <h1>Dashboard</h1>
    <div class="row pl-5 pr-5 pt-1 pb-0">
        <table class="table table-bordered table-hover" id="tableWebPage">
            <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Name</th>
                <th scope="col">Url</th>
                <th scope="col">Created</th>
                <th scope="col">Enabled</th>
                <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td colspan="6">No data</td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="row pl-5 pr-5 pt-0 pb-1">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalAddWebPage">Add WebPage to
            monitor
        </button>
    </div>
</div>

<div class="modal fade" id="modalAddWebPage" tabindex="-1" role="dialog" aria-labelledby="labelModalAddWebPage"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="labelModalAddWebPage">Add WebPage to monitor</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalAddWebPageName">Name</label>
                    <input type="text" class="form-control" id="modalAddWebPageName">
                </div>
                <div class="form-group">
                    <label for="modalAddWebPageUrl">URL</label>
                    <input type="text" class="form-control" id="modalAddWebPageUrl">
                </div>
                <div class="form-group">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="modalAddWebPageEnabled">
                        <label class="custom-control-label" for="modalAddWebPageEnabled">Toggle to enable or
                            disable</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="modalAddWebPageSubmit">Add WebPage</button>
            </div>
        </div>
    </div>
</div>

<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

<script>
    $(function () {
        let tableSummary = function (tBody, text) {
            tBody.find("tr").remove();
            tBody
                .append($('<tr>')
                    .append($('<td>')
                        .attr('colspan', 6)
                        .text(text)
                    )
                );
        };

        let fillTable = function (tBody, data) {
            if (Array.isArray(data)) {
                tBody.find("tr").remove();

                if (data.length === 0) {
                    tableSummary(tBody, 'No data!');
                } else {
                    data.forEach(function (item, i) {
                            let tr = $('<tr>');
                            tr.data('webPageId', item.id);
                            tr.append(
                                $('<th>')
                                    .attr('scope', 'row')
                                    .text(`${i + 1}`)
                            );
                            tr.append($('<td>').text(item.name));
                            tr.append($('<td>').text(item.url));
                            tr.append($('<td>').text(item.created));
                            tr.append($('<td>').text(item.enabled));
                            tr.append($('<td>').append(
                                $('<button>')
                                    .attr('type', 'button')
                                    .addClass('btn')
                                    .addClass('btn-primary')
                                    .addClass('btn-sm')
                                    .text('edit')
                                    .on({
                                        click: function (event) {
                                            event.preventDefault();

                                            let webPageId = $(event.target).closest('tr').data('webPageId');
                                            if (webPageId !== undefined) {
                                                window.location.assign('/web-page?id=' + webPageId);
                                            }
                                        }
                                    })
                            ));
                            tBody.append(tr);
                        }
                    );
                }
            } else {
                console.log(data);
                tableSummary(tBody, 'Error! Invalid data in response.');
            }
        };

        let loadWebPages = function () {
            let table = $("#tableWebPage");
            let tBody = table.find('tbody');

            tableSummary(tBody, 'Loading data...');

            $.ajax({
                type: "GET",
                url: "/api/user/me/web-page",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    fillTable(tBody, data);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus);
                    console.log(errorThrown);
                    tableSummary(tBody, 'Error! Unable to load web-pages.');
                }
            })
        };

        let createWebPagePayload = function () {
            let name = $("#modalAddWebPageName").val() || '';
            let url = $("#modalAddWebPageUrl").val() || '';
            let enabled = $("#modalAddWebPageEnabled:checked").val();

            return {
                name: name,
                url: url,
                enabled: enabled === 'on'
            };
        };

        $("#modalAddWebPageSubmit").on({
            click: function (event) {
                event.preventDefault();

                $.ajax({
                    type: "PUT",
                    url: `/api/user/me/web-page`,
                    data: JSON.stringify(createWebPagePayload()),
                    contentType: "application/json; charset=utf-8",
                    dataType: "text",
                    success: function (data) {
                        // TODO on save logic here
                        console.log(data);
                        $('#modalAddWebPage').modal('hide');
                        window.location.reload();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus);
                        console.log(errorThrown);
                        // TODO on error logic here
                        $('#modalAddWebPage').modal('hide');
                        window.alert(`Error while creating WebPage: ${textStatus}`);
                    }
                });
            }
        });

        loadWebPages();
    })
    ;
</script>
</body>
</html>
